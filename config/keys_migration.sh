#!/system/bin/sh

# SPDX-FileCopyrightText: 2017-2024 The LineageOS Project
# SPDX-License-Identifier: Apache-2.0

new_platform_signature="put_here_new_platform_signature"

# Check if the build time script was executed, otherwise exit because this will not work
if [[ $(/system/bin/echo $new_platform_signature | /system/bin/grep -i "new_platform_signature") ]]; then
   exit 1
fi

selinux_mac_file="/system/etc/selinux/plat_mac_permissions.xml"

# Safety check: verify that we are indeed running on a system with the new keys
if [[ ! $(/system/bin/grep -i $new_platform_signature $selinux_mac_file) ]]; then
    exit 2
fi

# Wait for /data to be mounted
while [[ ! -d /data/system ]]
do
    /system/bin/sleep 1
done

# New public keys
bluetooth_key_release=put_here_new_bluetooth_key
bluetooth_cert_release=put_here_new_bluetooth_cert
media_key_release=put_here_new_media_key
media_cert_release=put_here_new_media_cert
networkstack_key_release=put_here_new_networkstack_key
networkstack_cert_release=put_here_new_networkstack_cert
platform_key_release=put_here_new_platform_key
platform_cert_release=put_here_new_platform_cert
sdk_sandbox_key_release=put_here_new_sdk_sandbox_key
sdk_sandbox_cert_release=put_here_new_sdk_sandbox_cert
shared_key_release=put_here_new_shared_key
shared_cert_release=put_here_new_shared_cert

# Previous public keys - at the moment, the AOSP keys
bluetooth_key_test="MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAsVlq9pozUREGlb8u8Y0AfYwPs5OuavNx/EsX03aTjmAXUfSOMAewqzUXDIRjw8UQvOW63utaZ0go9osDPzNfVEftmGxW/AUC+HWGaLDQfCYO3ficPPOS7xpEhGZERNbnhvh5qX0NBt6mJygsfpOmRPThbi6Ig2Brxh1eqVYqRkTjhNFKD6gCd1PdMmUSF88xEYaZWvTkET89Zh38lLza2x/wfNZmCSAVurNw1Kf9NQfYsaGHwMsjrvTyhG93TTYXzRBFzAO2WlBiw6R0tQr8ZW5XCM9Yo6AS0KXiU0ZWwOXxhGdr38rNd7j9nZtpFwWmN1kgeb/vpEfq0Ylua9ByuURnfJZu2K4TbFamuyjihItra2ZKOtFNPDeuggKMCkuZz6WU8FCoMEpnq5P2agxNOGAa7ynXdNzek98N3TGX8qtfEgCv6vyuM0gakJ6D9nM43nsCm1LkB/JA0CacWyRzljaLL1C4S43azEOYyOOb94ITnkZCQGtH33kxzamyPLIZ37VF4+v6yTXySLBzOnheOs5uBIDohVJuI838bLhZf8e5mIrnjiKwsmExXiQvgidbwvZKCz9n8YT4iUhWPx4FW+GPcivZsvsECcnJ2QURK1zhir5QuLS7ZbAth4kiEUxJ6ujF5jftE+L/ClK2LiY02IXWRCct8J1hfJZZx8lm3PUCAwEAAQ=="
bluetooth_cert_test="3082063B30820423A003020102021412265AA5A599552B5EAF4E8224C7F69078BC3C8B300D06092A864886F70D01010B05003081AB310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E20566965773110300E060355040A0C07416E64726F69643110300E060355040B0C07416E64726F69643127302506035504030C1E636F6D2E616E64726F69642E626C7565746F6F74682E73657276696365733122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D3020170D3232303331353030333630335A180F34373630303230393030333630335A3081AB310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E20566965773110300E060355040A0C07416E64726F69643110300E060355040B0C07416E64726F69643127302506035504030C1E636F6D2E616E64726F69642E626C7565746F6F74682E73657276696365733122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D30820222300D06092A864886F70D01010105000382020F003082020A0282020100B1596AF69A3351110695BF2EF18D007D8C0FB393AE6AF371FC4B17D376938E601751F48E3007B0AB35170C8463C3C510BCE5BADEEB5A674828F68B033F335F5447ED986C56FC0502F8758668B0D07C260EDDF89C3CF392EF1A4484664444D6E786F879A97D0D06DEA627282C7E93A644F4E16E2E8883606BC61D5EA9562A4644E384D14A0FA8027753DD32651217CF311186995AF4E4113F3D661DFC94BCDADB1FF07CD666092015BAB370D4A7FD3507D8B1A187C0CB23AEF4F2846F774D3617CD1045CC03B65A5062C3A474B50AFC656E5708CF58A3A012D0A5E2534656C0E5F184676BDFCACD77B8FD9D9B691705A637592079BFEFA447EAD1896E6BD072B944677C966ED8AE136C56A6BB28E2848B6B6B664A3AD14D3C37AE82028C0A4B99CFA594F050A8304A67AB93F66A0C4D38601AEF29D774DCDE93DF0DDD3197F2AB5F1200AFEAFCAE33481A909E83F67338DE7B029B52E407F240D0269C5B247396368B2F50B84B8DDACC4398C8E39BF782139E4642406B47DF7931CDA9B23CB219DFB545E3EBFAC935F248B0733A785E3ACE6E0480E885526E23CDFC6CB8597FC7B9988AE78E22B0B261315E242F82275BC2F64A0B3F67F184F88948563F1E055BE18F722BD9B2FB0409C9C9D905112B5CE18ABE50B8B4BB65B02D878922114C49EAE8C5E637ED13E2FF0A52B62E2634D885D644272DF09D617C9659C7C966DCF50203010001A3533051301D0603551D0E04160414EE4282D43329B4C477F43DAF12B5E1AF41070159301F0603551D23041830168014EE4282D43329B4C477F43DAF12B5E1AF41070159300F0603551D130101FF040530030101FF300D06092A864886F70D01010B050003820201006AC64B5CE66A801156AEEA86863EC7349CD48FD3CDFEAF1BA687042F82708A12336A2AAFA4C61FE0031C063A8E1BBFAB3BF58A3DE0B6822702406D916BD8B0221578848F8FC42899C77C108796EFBA7E02B2B34B81D8E66D5CFCEE03FF9AE497A7347B116AE0F770F55F31C8CF7C42D2DDA23E31CF35D44CF388C2444E1E48FCA2D70C2F6F26FCC0B497FE1BF9F9479CFA8A16E2C18E1C62F5BFD97F06977E39314DC5E93379CF1FCCCDEE4689A52D5F3D6D48272C4962F4F4DB6B8AF9A7E97B34E6C92FF9D1A3A77141A30C9470F0270E07CF0EF25A62CC30F7B43ECFEA354EA514494B84A791512B6C89F5C5D58447AB9B8679F2707ED4983548C7EBCD77FB7A6036B7EFB6AEF196BE2E76C33DF575F8E83E45A2521088C981F632AA78C1C4675118DDB555BA89751CE8FDE3B864577698656D328B15AF48F0E0EF2BEB4A3DA0C3160536C5A71388F76F5075C57E5F52F3F00F01673D1F6977D9D99F6EB1CB6E5B616D6607B7B6C274EF3EE4BA135D6E79B6C9055F77416A889B1AA548E586071D155A0358FBAA39F580A06DF56E57BA7A2367C5F8E209C90F5B2722204EA5C3DEE7BDABC68E551A707E6A546F3A84E594EF1C8181E4343C7E1EF8DC6BE74C9403418CC678B581E7D9146F2A10F74D46E0D3D5076A0C687FF046B5D46114317740C64D14CEAC80B4B0EBE8C6F02BA9559AA99EB9E15DA20763BD0DE65DEF78"
media_key_test="MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEAriUMWhbvl/woaaxlGzIXzDa6DoaWQWjVigSfQM6FhnEjo/+09tlJwzzy2joFwj6sqlfYA4ibF1m89Z58byGJCuJQhbftVqpibAmJ75zNNjYsoOjRuWA/1Ngyh2eSbMwJDGi3da5/8wk0zDae8oVaJmffDGZ/0MfPXY66ZVgGc3MDu2JHJuq67fty8H7Xp2qzy5o4HEt9zYCbFA2JHwAhO+QB9Y1qBqYercOpwvHGVnKFsJrgk0Kmb6Qh6vk633VzoCjDMdcGAas698yEAz7OfHcqOluGsNvp13fDpIqpgB7c7ieBWJ9E2eQROXlgBXaplBC6gQkSWdrZjGxo/3hLjwIBAw=="
media_cert_test="308204A830820390A003020102020900F2B98E6123572C4E300D06092A864886F70D0101040500308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D301E170D3038303431353233343035375A170D3335303930313233343035375A308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D30820120300D06092A864886F70D01010105000382010D00308201080282010100AE250C5A16EF97FC2869AC651B3217CC36BA0E86964168D58A049F40CE85867123A3FFB4F6D949C33CF2DA3A05C23EACAA57D803889B1759BCF59E7C6F21890AE25085B7ED56AA626C0989EF9CCD36362CA0E8D1B9603FD4D8328767926CCC090C68B775AE7FF30934CC369EF2855A2667DF0C667FD0C7CF5D8EBA655806737303BB624726EABAEDFB72F07ED7A76AB3CB9A381C4B7DCD809B140D891F00213BE401F58D6A06A61EADC3A9C2F1C6567285B09AE09342A66FA421EAF93ADF7573A028C331D70601AB3AF7CC84033ECE7C772A3A5B86B0DBE9D777C3A48AA9801EDCEE2781589F44D9E4113979600576A99410BA81091259DAD98C6C68FF784B8F020103A381FC3081F9301D0603551D0E04160414CA293CAA8BC0ED3E542EEF4205A2BFF2B57E4D753081C90603551D230481C13081BE8014CA293CAA8BC0ED3E542EEF4205A2BFF2B57E4D75A1819AA48197308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D820900F2B98E6123572C4E300C0603551D13040530030101FF300D06092A864886F70D0101040500038201010084DE9516D5E4A87217A73DA8487048F53373A5F733F390D61BDF3CC9E5251625BFCAA7C3159CAE275D172A9AE1E876D5458127AC542F68290DD510C0029D8F51E0EE156B7B7B5ACDB394241B8EC78B74E5C42C5CAFAE156CAF5BD199A23A27524DA072DEBBE378464A533630B0E4D0FFB7E08ECB701FADB6379C74467F6E00C6ED888595380792038756007872C8E3007AF423A57A2CAB3A282869B64C4B7BD5FC187D0A7E2415965D5AAE4E07A6DF751B4A75E9793C918A612B81CD0B628AEE0168DC44E47B10D3593260849D6ADF6D727DC24444C221D3F9ECC368CAD07999F2B8105BC1F20D38D41066CC1411C257A96EA4349F5746565507E4E8020A1A81"
networkstack_key_test="MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAu3H1E3/wstdXrMLKPTeOD43hEJDVyvPUnjFNNcKDt3iwLXktjrpEA2TKlwmFRBZg8LwAr7xj3WEbG/Ua0ooe3SHgBI9Ui4D4vRE+JWgoIvV9q4Jzr68Sxk0ZoMa+I48+Zt3HmxD9kmkx4+5gp79hhkTaPCxPxCgTnUXSe+2n/kXjAHW0k+rW7AHN1V2THAplfi5ZdCymMrbcOEKi3rfSJEPICSkdelSSA65q41ZYKkyiPzDwVJxOyECKdSeOlcaeg5CtUoC876728TCaQb2fO/tdEtyn557G/WhIGT+pq3KCJIh7T5Pphex8v2QBsOhjpLkcBdBG8ED+lUAEsWRZVPy0EUzuHotktH1xmhnvTAAcsYP38+Fm5D9W1oBHw0QNo0/fUp1EJ0uLL2r7NFCRrYrUuTvVxV1SKGpdPBV0ZduN32LnzbaxD7GIiARq/dJjrm8hJdkGV1nH5C+GEKZ0btvcVH1DAWEu7sPDy9Ek3s7MjTiyDnOxPyTufKE6mMX2HwyBsH0rUZdJvCvLnglJrvbBGKPoEl5qtX/ORrsJGmZ0DhCzHHQLiRkAwOzanMaey08zaZmLF1EG3QpP/XAk6351/t0aWxMdC7K0DGNJHjz4a4lXshUhs6lu0TdqUaasaXhmsCVt7hvNmrmhiL9M7YC1ml8kwtqaVet7DlAhFuMCAwEAAQ=="
networkstack_cert_test="308205DC308203C4A003020102020900FC6CB0D8A6FDD168300D06092A864886F70D01010B0500308181310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E20566965773110300E060355040A0C07416E64726F69643110300E060355040B0C07416E64726F69643121301F06035504030C18636F6D2E616E64726F69642E6E6574776F726B737461636B3020170D3139303231323031343632305A180F34373537303130383031343632305A308181310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E20566965773110300E060355040A0C07416E64726F69643110300E060355040B0C07416E64726F69643121301F06035504030C18636F6D2E616E64726F69642E6E6574776F726B737461636B30820222300D06092A864886F70D01010105000382020F003082020A0282020100BB71F5137FF0B2D757ACC2CA3D378E0F8DE11090D5CAF3D49E314D35C283B778B02D792D8EBA440364CA970985441660F0BC00AFBC63DD611B1BF51AD28A1EDD21E0048F548B80F8BD113E25682822F57DAB8273AFAF12C64D19A0C6BE238F3E66DDC79B10FD926931E3EE60A7BF618644DA3C2C4FC428139D45D27BEDA7FE45E30075B493EAD6EC01CDD55D931C0A657E2E59742CA632B6DC3842A2DEB7D22443C809291D7A549203AE6AE356582A4CA23F30F0549C4EC8408A75278E95C69E8390AD5280BCEFAEF6F1309A41BD9F3BFB5D12DCA7E79EC6FD6848193FA9AB728224887B4F93E985EC7CBF6401B0E863A4B91C05D046F040FE954004B1645954FCB4114CEE1E8B64B47D719A19EF4C001CB183F7F3E166E43F56D68047C3440DA34FDF529D44274B8B2F6AFB345091AD8AD4B93BD5C55D52286A5D3C157465DB8DDF62E7CDB6B10FB18888046AFDD263AE6F2125D9065759C7E42F8610A6746EDBDC547D4301612EEEC3C3CBD124DECECC8D38B20E73B13F24EE7CA13A98C5F61F0C81B07D2B519749BC2BCB9E0949AEF6C118A3E8125E6AB57FCE46BB091A66740E10B31C740B891900C0ECDA9CC69ECB4F3369998B175106DD0A4FFD7024EB7E75FEDD1A5B131D0BB2B40C63491E3CF86B8957B21521B3A96ED1376A51A6AC697866B0256DEE1BCD9AB9A188BF4CED80B59A5F24C2DA9A55EB7B0E502116E30203010001A3533051301D0603551D0E041604149383C92CFBF099D5C47B0C3657D8622A084B72E1301F0603551D230418301680149383C92CFBF099D5C47B0C3657D8622A084B72E1300F0603551D130101FF040530030101FF300D06092A864886F70D01010B050003820201006A0501382FDE2A6B8F70C60CD1B8EE4F788718C288B170258EF3A96230B65005650D6A4C42A59A97B2DDEC502413E7B438FBD060363D74B74A232382A7F77FD3DA34E38F79FAD035A8B472C5CFF365818A0118D87FA1E31CC7ED4BEFD27628760C290980C3CC3B7FF0CFD01B75FF1FCC83E981B5B25A54D85B68A80424AC26015FB3A4C754969A71174C0BC283F6C88191DCED609E245F5938FFD0AD799198E2D0BF6342221C1B0A5D332ED2FFFC668982CABBCB7D3B630FF8476E5C84AC0AD37ADF9224035200039F95EC1FA95BF83796C0E8986135CEE2DCAEF190B249855A7E7397D4A0BF17EA63D978589C6B48118A381FFFBD790C44D80233E2E35292A3B5533CA3F2CC173F85CF904ADFE2E4E2183DC1EBA0EBAE07B839A81FF1BC92E292550957C8599AF21E9C0497B9234CE345F3F508B1CC872AA55DDB5E773C5C7DD6577B9A8B6DAED20AE1FF4B8206FD9F5C8F5A22BA1980BEF01AE6FCB2659B97AD5B985FA81C019FFE008DDD9C8130C06FC6032B2149C2209FC438A7E8C3B20CE03650AD31C4EE48F169777A0AE182B72CA31B81540F61F167D8D7ADF4F6BB2330FF5C24037245000D8172C12AB5D5AA5890B8B12DB0F0E7296264EB66E7F9714C31004649FB4B864005F9C43C80DB3F6DE52FD44D6E2036BFE7F5807156ED5AB591D06FD6BB93BA4334EA2739AF8B41ED2686454E60B666D10738BB7BA88001"
platform_key_test="MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEAnHgFkqwNXTgc3qpl7MimAG42SAxtcgexIBG+UIY6q+K1XQCa33FG1vIgIoDHzU172yYkO4qAbCazSxN1I6SSaCJJBNwBST58Cs8aBch09psDe2AwnZB00kKA4WutKoc0NhlR6vcqSC0JsgSxh14SrJjBqnc9aAC56v3lbVi+2OjaFvmjYAmcN6g0pt/tt7a0SgSeB6Jp/M8sVJbyzzbWTfkKO42PNKO6q0z1M3GrJ3GbO6WHVK0MU/wU4dtF1R4jT7vpPJuk7fnOVCYTUOxTVge/aaL/SqB9tffqIA0JpsG0niFAL4ntEZCJOqtakYDxUugvhaRXU89fwZBxxe7IJwIBAw=="
platform_cert_test="308204A830820390A003020102020900B3998086D056CFFA300D06092A864886F70D0101040500308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D301E170D3038303431353232343035305A170D3335303930313232343035305A308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D30820120300D06092A864886F70D01010105000382010D003082010802820101009C780592AC0D5D381CDEAA65ECC8A6006E36480C6D7207B12011BE50863AABE2B55D009ADF7146D6F2202280C7CD4D7BDB26243B8A806C26B34B137523A49268224904DC01493E7C0ACF1A05C874F69B037B60309D9074D24280E16BAD2A8734361951EAF72A482D09B204B1875E12AC98C1AA773D6800B9EAFDE56D58BED8E8DA16F9A360099C37A834A6DFEDB7B6B44A049E07A269FCCF2C5496F2CF36D64DF90A3B8D8F34A3BAAB4CF53371AB27719B3BA58754AD0C53FC14E1DB45D51E234FBBE93C9BA4EDF9CE54261350EC535607BF69A2FF4AA07DB5F7EA200D09A6C1B49E21402F89ED1190893AAB5A9180F152E82F85A45753CF5FC19071C5EEC827020103A381FC3081F9301D0603551D0E041604144FE4A0B3DD9CBA29F71D7287C4E7C38F2086C2993081C90603551D230481C13081BE80144FE4A0B3DD9CBA29F71D7287C4E7C38F2086C299A1819AA48197308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D820900B3998086D056CFFA300C0603551D13040530030101FF300D06092A864886F70D01010405000382010100572551B8D93A1F73DE0F6D469F86DAD6701400293C88A0CD7CD778B73DAFCC197FAB76E6212E56C1C761CFC42FD733DE52C50AE08814CEFC0A3B5A1A4346054D829F1D82B42B2048BF88B5D14929EF85F60EDD12D72D55657E22E3E85D04C831D613D19938BB8982247FA321256BA12D1D6A8F92EA1DB1C373317BA0C037F0D1AFF645AEF224979FBA6E7A14BC025C71B98138CEF3DDFC059617CF24845CF7B40D6382F7275ED738495AB6E5931B9421765C491B72FB68E080DBDB58C2029D347C8B328CE43EF6A8B15533EDFBE989BD6A48DD4B202EDA94C6AB8DD5B8399203DAAE2ED446232E4FE9BD961394C6300E5138E3CFD285E6E4E483538CB8B1B357"
sdk_sandbox_key_test="MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA09j3dyTxv8ojb4sXjrWXsmXTYEez/u6X6po8+mWXp1xl1Y9xjYrxZROIE1MJL8aay8iYJihqx7RBWTPJYtYZTLElA3dyQuMgDIKtlQR3QAMRoc2IKrkfcIboEs71xl78EnTSQfRJTUEFvNigzjfBe3JVtNDC9BR/33Iv9oNED84qW9C54h4TWHLyvo75unzPQUGS6uEIhhHa/8ynZZQWYEd0NwAQNqbcMdbN8Bn6sRRCidEOIPd8Uu8DtIofLi7/YMo4CH1Q5f5UQbtPtqU2m8fjQN9WYzMazvWltRE+HYDH9YnXCLAsVicNdmFhAlXri15nG2AiRnSrHu/panAc6wIDAQAB"
sdk_sandbox_cert_test="3082040B308202F3A0030201020214316246427AC953BCC11293EABFADEED873A589BD300D06092A864886F70D01010B0500308194310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E20566965773110300E060355040A0C07416E64726F69643110300E060355040B0C07416E64726F69643110300E06035504030C07416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D301E170D3231313130323137303231345A170D3439303332303137303231345A308194310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E20566965773110300E060355040A0C07416E64726F69643110300E060355040B0C07416E64726F69643110300E06035504030C07416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D30820122300D06092A864886F70D01010105000382010F003082010A0282010100D3D8F77724F1BFCA236F8B178EB597B265D36047B3FEEE97EA9A3CFA6597A75C65D58F718D8AF16513881353092FC69ACBC89826286AC7B4415933C962D6194CB12503777242E3200C82AD950477400311A1CD882AB91F7086E812CEF5C65EFC1274D241F4494D4105BCD8A0CE37C17B7255B4D0C2F4147FDF722FF683440FCE2A5BD0B9E21E135872F2BE8EF9BA7CCF414192EAE1088611DAFFCCA765941660477437001036A6DC31D6CDF019FAB1144289D10E20F77C52EF03B48A1F2E2EFF60CA38087D50E5FE5441BB4FB6A5369BC7E340DF5663331ACEF5A5B5113E1D80C7F589D708B02C56270D7661610255EB8B5E671B60224674AB1EEFE96A701CEB0203010001A3533051301D0603551D0E04160414DC5E6BD838496D17E424ABAAB358633FFD1D0941301F0603551D23041830168014DC5E6BD838496D17E424ABAAB358633FFD1D0941300F0603551D130101FF040530030101FF300D06092A864886F70D01010B05000382010100C1043CFC3DDFFD64B9730A9CB05A53F90CE293DC93BB9DE7B17CFFA410D26DE337CD7D5109E8D7B265E13E337B72ED2E25896B22E02B39A807482E690DC8BA1B3730BA79E79116B3480993A472D246079B70B80A1CB0A987DB2E948D6BF36C7DBA9178EF32E56DF913AED189AF27A3FB2589D8D7BC8AB2483DE351D33D2C4C1589D8D820E797B31568F79A2873C3867A614F6DC4907B1A3F5E3585DD72E6E3A0DB3699253FE9D47E1F026D0FAE05B87DF140B18C66C722CC237C37A6F9C5ACA3C0FB2CCD085A1C8E22478A0627DA6B6C3774268CA5C16AF62EB42162E5900A7DB4706E5886BB59B218FA7F57865754C361DF31CE26A98A5AB0CEB721011BCFF2"
shared_key_test="MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEAyMLb/QlKLfRcP/GjLtIYBexy/FjQF5cb0Pa1LCYtcIGdGRln4Vjf06LH8bPg6AzlRdedKEgiAhHrhvD9gxLTe0IMETdQzJRhiuhy9IhkY73EYnyqDASDyGST41FVcRcDOL/cxM1q3dHAovNfXPJO0+QEOj5Y4rBeZkzN4SvLZ3Nf1t8SScNp5iVCvApHKeU5F/XDj/pS0Xtzycc3mN2xjtSBWQh1VH5mv8XaykwlpuuWDtlpI3CdowK6ZGy0lrMl6Gxciy56M3eyu+THzzMlQpEWP2iRUqwIhVDIPFCPS/Wt8K7VotygWD+asK0XZQ237qSyP9tFiFVH0P6rchg4iQIBAw=="
shared_cert_test="308204A830820390A003020102020900F2A73396BD38767A300D06092A864886F70D0101040500308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D301E170D3038303732333231353735395A170D3335313230393231353735395A308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D30820120300D06092A864886F70D01010105000382010D00308201080282010100C8C2DBFD094A2DF45C3FF1A32ED21805EC72FC58D017971BD0F6B52C262D70819D191967E158DFD3A2C7F1B3E0E80CE545D79D2848220211EB86F0FD8312D37B420C113750CC94618AE872F4886463BDC4627CAA0C0483C86493E3515571170338BFDCC4CD6ADDD1C0A2F35F5CF24ED3E4043A3E58E2B05E664CCDE12BCB67735FD6DF1249C369E62542BC0A4729E53917F5C38FFA52D17B73C9C73798DDB18ED481590875547E66BFC5DACA4C25A6EB960ED96923709DA302BA646CB496B325E86C5C8B2E7A3377B2BBE4C7CF33254291163F689152AC088550C83C508F4BF5ADF0AED5A2DCA0583F9AB0AD17650DB7EEA4B23FDB45885547D0FEAB72183889020103A381FC3081F9301D0603551D0E04160414CB4C7E2CDBB3F0ADA98DAB79968D172E9DBB1ED13081C90603551D230481C13081BE8014CB4C7E2CDBB3F0ADA98DAB79968D172E9DBB1ED1A1819AA48197308194310B3009060355040613025553311330110603550408130A43616C69666F726E6961311630140603550407130D4D6F756E7461696E20566965773110300E060355040A1307416E64726F69643110300E060355040B1307416E64726F69643110300E06035504031307416E64726F69643122302006092A864886F70D0109011613616E64726F696440616E64726F69642E636F6D820900F2A73396BD38767A300C0603551D13040530030101FF300D06092A864886F70D0101040500038201010040A8D096997959E917A36C44246B6BAC2BAE05437ECD89794118F7834720352D1C6F8A39B0869942F4DA65981FAA2951D33971129EC1921D795671C527D6E249F252829FAF5B591310311E2DE096500D568AD4114A656DC34A8C6F610453AFC1EA7992DBA4AA7B3F8543A6E35C0728DE77FE97EEAC83771FD0EC90F8E4449434EE0B6045783E70C7A2E460249260E003CF7608DC352A4C9EF706DEF4B26050E978AE2FFFD7A3323787014915EB3CC874FCC7A9AE930877C5C8C7D1C2E2A8EE863C89180D1855CEDBA400E7BA43CCCAA7243D397E7C0E8E8E4D7D4F92B6BBEAD49C0CF018069EDDCA2E7E2FB4668D89DBBD7950D0CD254180FA1EAAFC2A556F84"

PACKAGES=/data/system/packages.xml
PACKAGES_BACKUP=/data/system/packages-backup.xml
MODIFICATION_TARGET=$PACKAGES

# If the xml file already has the new keys, no need to proceed
if [[ $(/system/bin/grep -i $platform_key_release $MODIFICATION_TARGET) ]]; then
    exit 3
fi

# If there's a "backup" copy, then the current packages.xml might
# be corrupted, so overwrite it with the backup copy. This is what
# PackageManager would do.
if [ -f $PACKAGES_BACKUP ]; then
    mv $PACKAGES_BACKUP $PACKAGES
fi

if [ ! -f $PACKAGES ]; then
    exit 4
fi

# Save a copy of the current file, not to be confused with
# packages-backup.xml, which is used and generated by Android
cp $PACKAGES $PACKAGES.bak

/system/bin/sed -i "s#$media_cert_test#$media_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$platform_cert_test#$platform_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$shared_cert_test#$shared_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$bluetooth_cert_test#$bluetooth_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$sdk_sandbox_cert_test#$sdk_sandbox_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$networkstack_cert_test#$networkstack_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$media_key_test#$media_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$platform_key_test#$platform_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$shared_key_test#$shared_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$bluetooth_key_test#$bluetooth_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$sdk_sandbox_key_test#$sdk_sandbox_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$networkstack_key_test#$networkstack_key_release#g" $MODIFICATION_TARGET

/system/bin/chmod 660 $PACKAGES
/system/bin/chown system:system $PACKAGES

PACKAGES_COPY=/data/system/packages.xml.reservecopy
MODIFICATION_TARGET=$PACKAGES_COPY

if [ -f $PACKAGES_BACKUP ]; then
    mv $PACKAGES_BACKUP $PACKAGES
fi

if [ ! -f $PACKAGES_COPY ]; then
    exit 5
fi

cp $PACKAGES_COPY $PACKAGES_COPY.bak

/system/bin/sed -i "s#$media_cert_test#$media_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$platform_cert_test#$platform_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$shared_cert_test#$shared_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$bluetooth_cert_test#$bluetooth_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$sdk_sandbox_cert_test#$sdk_sandbox_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$networkstack_cert_test#$networkstack_cert_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$media_key_test#$media_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$platform_key_test#$platform_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$shared_key_test#$shared_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$bluetooth_key_test#$bluetooth_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$sdk_sandbox_key_test#$sdk_sandbox_key_release#g" $MODIFICATION_TARGET
/system/bin/sed -i "s#$networkstack_key_test#$networkstack_key_release#g" $MODIFICATION_TARGET

/system/bin/chmod 660 $PACKAGES_COPY
/system/bin/chown system:system $PACKAGES_COPY

exit 0
